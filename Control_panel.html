
<!DOCTYPE html>
<html>

<head>
  <title></title>
  <meta http-equiv="Content-Type" content="text/html" ; charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=8" />
  <!--LIBRERIAS-->

  <link href='https://fonts.googleapis.com/css?family=Roboto:300italic,400italic,300,400,500,700,900' rel='stylesheet'
    type='text/css' />

  <link rel="stylesheet"
    href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T"
    crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">

  <link type="text/css" rel="stylesheet" href="https://cdn.datatables.net/1.11.5/css/jquery.dataTables.min.css" />


  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p"
    crossorigin="anonymous"></script>
  <script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>

  <script src="https://cdn.jsdelivr.net/npm/jquery-validation@1.19.3/dist/jquery.validate.js"></script>

  <style type="text/css">
    #tblDatos {
      font-size: 11px;
    }

    #tblDatos.dataTable tbody th,
    table.dataTable tbody td {
      padding: 0px 2px 0px 5px;
    }
  </style>
  <script type="text/javascript">
    jQuery(document).ready(function () {

      $("#frmPrincipal").validate({
        submitHandler: function (form) {

          if ($('#txtAux').val() == '0') {
            $.ajax({
              url: "agregar.php",
              type: "POST",
              data: ({
                rut: $('#rut').val(),
                nombre: $('#nombre').val(),
                apellidoPaterno: $('#apellidoPaterno').val(),
                apellidoMaterno: $('#apellidoMaterno').val(),
                email: $('#email').val(),
              }),
              dataType: "text",
              async: false,
              success: function (resp) {
                if (resp > 0) {
                  alert('Insertado satisfactoriamente');
                  location.reload();
                }
                else {
                  alert('Registro no fue Insertado');
                }
              }
            });
          } else {
            $.ajax({
              url: "actualizar.php",
              type: "POST",
              data: ({
                rut: $('#rut').val(),
                nombre: $('#nombre').val(),
                apellidoPaterno: $('#apellidoPaterno').val(),
                apellidoMaterno: $('#apellidoMaterno').val(),
                email: $('#email').val(),
              }),
              dataType: "text",
              async: false,
              success: function (resp) {
                if (resp > 0) {
                  alert('Registro Editado Satisfactoriamente');
                  location.reload();
                }
                else {
                  alert('Registro no fue Editado');
                }
              }
            });
          }
        }
      });

      //jQuery("#btnGuardar").click(function(){
      //});


      let data = [];

      $("#tblDatos").DataTable({
        responsive: true,
        language: {
          url: "https://cdn.datatables.net/plug-ins/1.10.15/i18n/Spanish.json"
        },
        data: data,
        columns: [
          {
            data: "rut", title: "rut",
            render: function (data, type, row, meta) {
              let html = "";
              if (type === "display") {
                html = data;
              }
              return html;
            }
          },
          {
            data: "nombre", title: "nombre",
            render: function (data, type, row, meta) {
              let html = "";
              if (type === "display") {
                html = data;
              }
              return html;
            }
          },
          {
            data: "apellidoPaterno", title: "apellidoPaterno",
            render: function (data, type, row, meta) {
              let html = "";
              if (type === "display") {
                html = data;
              }
              return html;
            }
          },
          {
            data: "apellidoMaterno", title: "apellidoMaterno",
            render: function (data, type, row, meta) {
              let html = "";
              if (type === "display") {
                html = data;
              }
              return html;
            }
          },
          {
            data: "email", title: "email",
            render: function (data, type, row, meta) {
              let html = "";
              if (type === "display") {
                html = data;
              }
              return html;
            }
          },
          {
            data: "rut", title: "Acciones", class: "text-center", width: "15%",
            render: function (data, type, row, meta) {
              let html = "";
              if (type === "display") {
                html = '<div class="actions text-center"></div>';
              }
              return html;
            }
          },
        ],
        fnRowCallback: function (r, d, i, fi) {
          var $d = $(r).find(".actions");
          $(r).data("data", d);
          if ($(r).find("a").length <= 0) {
            var $b1 = $('<button type="button" class="btn btn-outline-warning" data-toggle="tooltip" data-placement="top" data-original-title="Editar"><i class="bi bi-pencil-fill"></i></button>').off("click").on("click", { tr: r }, fncEditar);
            var $b2 = $('<button type="button" class="btn btn-outline-danger" data-toggle="tooltip" data-placement="top" data-original-title="Eliminar"><i class="bi bi-trash"></i></button>').off("click").on("click", { tr: r }, fncEliminar);
            $d.append($b1).append("&nbsp;");
            $d.append($b2).append("&nbsp;");
          }
        },
        dom: '<"toolbar">frtip',
        "initComplete": function () {
          $("div.toolbar").css("float", "left");
          $("div.toolbar").append('<button onclick="fncAgregar();" class="btn btn-outline-success" data-bs-toggle="modal" data-bs-target="#mdlAgregar" data-bs-whatever="@mdo"><i class="bi bi-plus-square-fill"></i> Agregar...</button>');
        }
      });


      $.ajax({
        url: "https://www.colex.cl/duoc/PGY3121/listado.php",
        type: "POST",
        dataType: "jsonp",
        async: false,
        success: function (resp) {
          data = resp;
          let datatable = $("#tblDatos").DataTable();
          datatable.clear().draw();
          datatable.rows.add(data); // Add new data
          datatable.columns.adjust().draw(); // Redraw the DataTable
        },
        complete: function (a, b, c) {
          console.log();
        },
        error: function (a, b, c) {
          console.log();
        },
        jsonpCallback: "logResults"
      });

    });

    function fncAgregar() {
      $('#rut').parents('form')[0].reset();
      $('#rut').removeAttr('disabled');
    }

    function fncEditar(e) {
      var tr = $(e.data.tr);
      var data = tr.data("data");

      $('#txtAux').val('1');
      $('#rut').attr('disabled', true);
      $('#rut').val(data.rut);
      $('#nombre').val(data.nombre);
      $('#apellidoPaterno').val(data.apellidoPaterno);
      $('#apellidoMaterno').val(data.apellidoMaterno);
      $('#email').val(data.email);

      $("#mdlAgregar").modal("show");
    }

    function fncEliminar(e) {
      var tr = $(e.data.tr);
      var data = tr.data("data");

      if (confirm("Desea eliminar este registro?")) {
        $.ajax({
          url: "eliminar.php",
          type: "POST",
          data: data,
          dataType: "text",
          async: false,
          success: function (resp) {
            if (resp > 0) {
              alert('Eliminado satisfactoriamente');
              location.reload();
            } else
              alert('Registro no fue Eliminado');
          }
        });
      }
    }

    function logResults(json) {
      //console.log(json);
    }

  </script>
</head>

<body>
  <br>
  <center>
    <table id="tblDatos" class="display" width="100%">
      <thead class="table-dark">
      </thead>
    </table>
  </center>
  <br />

  <style>
    .oculto {
      display: none;
    }
  </style>
</body>

</html>